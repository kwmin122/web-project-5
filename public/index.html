<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ë§¤ì¹­ ì‹ ì²­</title>
  <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    body {
      font-family: 'Noto Sans KR', sans-serif;
      padding: 0;
      margin: 0;
      background-color: #fff8f3;
      color: #333;
    }

    .container {
      max-width: 500px;
      margin: 60px auto;
      background-color: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    h2, h3, h4 {
      color: #d66b42;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      font-weight: bold;
      margin-bottom: 6px;
      color: #444;
    }

    input, select, textarea {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 8px;
      box-sizing: border-box;
      background-color: #fffefc;
    }

    button {
      background-color: #f8a88d;
      color: white;
      padding: 10px 16px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    button:hover {
      background-color: #e96e50;
    }

    .profile-card {
      background-color: #fffefc;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 20px;
      margin-top: 10px;
    }

    .slider-buttons {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .slider-buttons button {
      flex: 1;
      margin: 0 5px;
    }

    #alert-box {
      background-color: #ffe9c9;
      border-left: 5px solid #f0c000;
      color: #855700;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 6px;
      font-weight: bold;
    }

    #group-members-section {
      margin-top: 20px;
      padding: 15px;
      background-color: #fff5ee;
      border: 1px solid #f0dcd0;
      border-radius: 10px;
    }

    #status-message {
      font-size: 16px;
      padding: 10px 0;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="alert-box" class="hidden">ğŸ”” ìƒˆë¡œìš´ ë§¤ì¹­ ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!</div>

    <div id="start-screen">
      <h2>ì‹ ì²­</h2>
      <button onclick="showTypeSelection()">ì‹ ì²­í•˜ê¸°</button>
    </div>

    <div id="type-selection" class="hidden">
      <h3>ì‹ ì²­ ìœ í˜• ì„ íƒ</h3>
      <button onclick="selectType('ê°œì¸')">ê°œì¸</button>
      <button onclick="selectType('ë‹¨ì²´')">ë‹¨ì²´</button>
    </div>

    <div id="form-container" class="hidden">
      <h3>ì‹ ì²­ì ì •ë³´ ì…ë ¥</h3>
      <form id="user-form">
        <div class="form-group">
          <label for="name">ì´ë¦„</label>
          <input type="text" id="name" required />
        </div>
        <div class="form-group">
          <label for="major">í•™ê³¼</label>
          <input type="text" id="major" required />
        </div>
        <div class="form-group">
          <label for="gender">ì„±ë³„</label>
          <select id="gender" required>
            <option value="">ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ë‚¨">ë‚¨</option>
            <option value="ì—¬">ì—¬</option>
          </select>
        </div>
        <div class="form-group">
          <label for="ideal">ì´ìƒí˜•</label>
          <input type="text" id="ideal" required />
        </div>
        <div class="form-group">
          <label for="intro">í•œì¤„ ì†Œê°œ</label>
          <input type="text" id="intro" required />
        </div>

        <div id="group-members-section" class="hidden">
          <h4>ë‹¨ì²´ êµ¬ì„±ì› ìµœëŒ€ 3ëª…</h4>
          <div class="form-group" id="group-member-forms"></div>
        </div>

        <button type="button" onclick="submitProfile()">í”„ë¡œí•„ ì‘ì„± ì™„ë£Œ</button>
      </form>
    </div>

    <div id="matching-screen" class="hidden">
      <h3>ëœë¤ ë§¤ì¹­</h3>
      <div id="random-profile" class="profile-card"></div>
      <div class="slider-buttons">
        <button onclick="prevProfile()">ì´ì „</button>
        <button onclick="nextProfile()">ë‹¤ìŒ</button>
      </div>
    </div>

    <div id="notification-screen" class="hidden">
      <h3>ë§¤ì¹­ ìš”ì²­ ë°›ìŒ</h3>
      <div id="received-profile" class="profile-card"></div>
      <div class="slider-buttons">
        <button onclick="acceptMatch()">ìˆ˜ë½</button>
        <button onclick="declineMatch()">ê±°ì ˆ</button>
      </div>
    </div>

    <div id="status-screen" class="hidden">
      <h3>ë§¤ì¹­ ìƒíƒœ</h3>
      <p id="status-message"></p>
    </div>
  </div>

  <script>
    const socket = io("http://localhost:3000");
    const userProfile = {};
    let allProfiles = [];
    let currentProfileIndex = 0;
    let selectedProfile = null;
    let currentMatchFromId = null;
    let myName = "";
    let matchedName = "";

    function showTypeSelection() {
      document.getElementById("start-screen").classList.add("hidden");
      document.getElementById("type-selection").classList.remove("hidden");
    }

    function selectType(type) {
      userProfile.isGroup = type === 'ë‹¨ì²´';
      document.getElementById("type-selection").classList.add("hidden");
      document.getElementById("form-container").classList.remove("hidden");
      const groupSection = document.getElementById("group-members-section");
      const groupForm = document.getElementById("group-member-forms");
      groupForm.innerHTML = "";
      if (userProfile.isGroup) {
        groupSection.classList.remove("hidden");
        for (let i = 0; i < 3; i++) {
          groupForm.innerHTML += `
            <div class="form-group">
              <label>êµ¬ì„±ì› ${i + 1} ì´ë¦„</label>
              <input type="text" id="member-name-${i}" />
              <label>í•™ê³¼</label>
              <input type="text" id="member-major-${i}" />
              <label>ì´ìƒí˜•</label>
              <input type="text" id="member-ideal-${i}" />
              <label>ì†Œê°œ</label>
              <input type="text" id="member-intro-${i}" />
            </div>
          `;
        }
      } else {
        groupSection.classList.add("hidden");
      }
    }

    function submitProfile() {
      userProfile.name = document.getElementById("name").value;
      userProfile.major = document.getElementById("major").value;
      userProfile.gender = document.getElementById("gender").value;
      userProfile.ideal = document.getElementById("ideal").value;
      userProfile.intro = document.getElementById("intro").value;
      myName = userProfile.name;

      if (userProfile.isGroup) {
        userProfile.groupMembers = [];
        for (let i = 0; i < 3; i++) {
          const name = document.getElementById(`member-name-${i}`).value;
          const major = document.getElementById(`member-major-${i}`).value;
          const ideal = document.getElementById(`member-ideal-${i}`).value;
          const intro = document.getElementById(`member-intro-${i}`).value;
          if (name) {
            userProfile.groupMembers.push({ name, major, ideal, intro });
          }
        }
      }

      socket.emit("register", userProfile);
      document.getElementById("form-container").classList.add("hidden");
      document.getElementById("matching-screen").classList.remove("hidden");
    }

    socket.on("update_profiles", (profiles) => {
      allProfiles = profiles;
      currentProfileIndex = 0;
      showRandomProfile();
    });

    function showRandomProfile() {
      const profile = allProfiles[currentProfileIndex];
      if (!profile) {
        document.getElementById("random-profile").innerHTML = "í‘œì‹œí•  í”„ë¡œí•„ì´ ì—†ìŠµë‹ˆë‹¤.";
        return;
      }

      const profileDiv = document.getElementById("random-profile");
      let groupInfo = "";
      if (profile.isGroup && Array.isArray(profile.groupMembers)) {
        groupInfo = profile.groupMembers.map((member, i) => `
          <div style="margin-top: 10px; padding-left: 10px;">
            <strong>êµ¬ì„±ì› ${i + 1}</strong><br />
            ì´ë¦„: ${member.name}<br />
            í•™ê³¼: ${member.major}<br />
            ì´ìƒí˜•: ${member.ideal}<br />
            ì†Œê°œ: ${member.intro}
          </div>
        `).join("");
      }

      profileDiv.innerHTML = `
        <p><strong>ì´ë¦„:</strong> ${profile.name}</p>
        <p><strong>í•™ê³¼:</strong> ${profile.major}</p>
        <p><strong>ì„±ë³„:</strong> ${profile.gender}</p>
        <p><strong>ì´ìƒí˜•:</strong> ${profile.ideal}</p>
        <p><strong>ì†Œê°œ:</strong> ${profile.intro}</p>
        ${groupInfo}
        <button onclick="sendMatchRequest('${profile.socketId}')">ë§¤ì¹­ ë³´ë‚´ê¸°</button>
      `;
    }

    function nextProfile() {
      currentProfileIndex = (currentProfileIndex + 1) % allProfiles.length;
      showRandomProfile();
    }

    function prevProfile() {
      currentProfileIndex = (currentProfileIndex - 1 + allProfiles.length) % allProfiles.length;
      showRandomProfile();
    }

    function sendMatchRequest(targetSocketId) {
      selectedProfile = allProfiles[currentProfileIndex];
      socket.emit("send_match", targetSocketId);
      document.getElementById("matching-screen").classList.add("hidden");
      document.getElementById("status-screen").classList.remove("hidden");
      document.getElementById("status-message").innerText = `ë§¤ì¹­ ìš”ì²­ì„ ë³´ëƒˆìŠµë‹ˆë‹¤. ëŒ€ê¸° ì¤‘...`;
    }

    socket.on("receive_match", ({ from, fromId }) => {
      currentMatchFromId = fromId;
      const profileDiv = document.getElementById("received-profile");
      let groupInfo = "";

      if (from.isGroup && Array.isArray(from.groupMembers)) {
        groupInfo = from.groupMembers.map((member, i) => `
          <div style="margin-top: 10px; padding-left: 10px;">
            <strong>êµ¬ì„±ì› ${i + 1}</strong><br />
            ì´ë¦„: ${member.name}<br />
            í•™ê³¼: ${member.major}<br />
            ì´ìƒí˜•: ${member.ideal}<br />
            ì†Œê°œ: ${member.intro}
          </div>
        `).join("");
      }

      profileDiv.innerHTML = `
        <p><strong>ì´ë¦„:</strong> ${from.name}</p>
        <p><strong>í•™ê³¼:</strong> ${from.major}</p>
        <p><strong>ì„±ë³„:</strong> ${from.gender}</p>
        <p><strong>ì´ìƒí˜•:</strong> ${from.ideal}</p>
        <p><strong>ì†Œê°œ:</strong> ${from.intro}</p>
        ${groupInfo}
      `;

      document.getElementById("notification-screen").classList.remove("hidden");
      document.getElementById("status-screen").classList.add("hidden");
    });

  function acceptMatch() {
    if (currentMatchFromId) {
      socket.emit("accept_match", currentMatchFromId);

        // âœ… ë‚´ ì´ë¦„ ì„¤ì •
        myName = userProfile.name;

        document.getElementById("notification-screen").classList.add("hidden");
        document.getElementById("status-screen").classList.remove("hidden");
        document.getElementById("status-message").innerHTML = `
          ë§¤ì¹­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.<br/>
          <button onclick="startChat()">ì±„íŒ…ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</button>
        `;
      }
    }
    function declineMatch() {
      if (currentMatchFromId) {
        socket.emit("decline_match", currentMatchFromId);
        document.getElementById("notification-screen").classList.add("hidden");
        document.getElementById("status-screen").classList.remove("hidden");
        document.getElementById("status-message").innerText = "ë§¤ì¹­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.";
      }
    }

    socket.on("match_result", ({ status, fromId, name }) => {
      if (status === "ìˆ˜ë½") {
        matchedName = name;
        localStorage.setItem("matchedUser", JSON.stringify({ name }));
        document.getElementById("status-screen").classList.remove("hidden");
        document.getElementById("status-message").innerHTML = `
          ìƒëŒ€ë°©ì´ ë§¤ì¹­ì„ ìˆ˜ë½í–ˆìŠµë‹ˆë‹¤.<br/>
          <button onclick="startChat()">ì±„íŒ…ì„ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?</button>
        `;
      } else if (status === "ê±°ì ˆ") {
        document.getElementById("status-screen").classList.remove("hidden");
        document.getElementById("status-message").innerHTML = `
          ìƒëŒ€ë°©ì´ ë§¤ì¹­ì„ ê±°ì ˆí–ˆìŠµë‹ˆë‹¤.<br/>
          <button onclick="restartMatching()">ë‹¤ë¥¸ ì¸ì—° ì°¾ì•„ë³´ê¸°</button>
        `;
      }
    });

    function startChat() {
      alert("ì±„íŒ… í˜ì´ì§€ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
      window.location.href = `/chat.html?me=${encodeURIComponent(myName)}&with=${encodeURIComponent(matchedName)}`;
    }

    function restartMatching() {
      document.getElementById("status-screen").classList.add("hidden");
      document.getElementById("matching-screen").classList.remove("hidden");
      showRandomProfile();
    }
  </script>
</body>
</html>
